<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flutter WASM (Threaded)</title>
</head>
<body>
  <h1>Flutter WASM with Shared Memory</h1>
  <pre id="log">Starting...\n</pre>

  <script>
    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\n";
      console.log(msg);
    };

    (async () => {
      log("crossOriginIsolated = " + self.crossOriginIsolated);

      try {
        const resp = await fetch("module.wasm");
        if (!resp.ok) throw new Error("Fetch failed: " + resp.status);

        const bytes = await resp.arrayBuffer();
        const module = await WebAssembly.compile(bytes);

        // Shared memory required
        const memory = new WebAssembly.Memory({
          initial: 256,   // adjust pages (256 * 64KiB = 16MB)
          maximum: 1024,
          shared: true
        });

        const importObject = { ffi: { memory } };

        const { instance } = await WebAssembly.instantiate(module, importObject);
        log("WASM loaded. Exports: " + Object.keys(instance.exports));
      } catch (e) {
        log("Error: " + e);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
